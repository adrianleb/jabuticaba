// Generated by CoffeeScript 1.3.3
(function() {
  var AudioBoss;

  AudioBoss = (function() {

    function AudioBoss() {}

    AudioBoss.prototype.effects = {};

    AudioBoss.prototype.rootScales = {
      'aMinor': [21, 23, 24, 26, 28, 29, 31]
    };

    AudioBoss.prototype.scale = [];

    AudioBoss.prototype.source = false;

    AudioBoss.prototype.instruments = {
      'brom': {
        ramps: {
          "in": 0.001,
          out: 0.01
        },
        osc1Type: 0,
        osc2Type: 2,
        mod: 0.2
      },
      'blar': {
        ramps: {
          "in": 0.1,
          out: 0.01
        },
        osc1Type: 1,
        osc2Type: 1,
        mod: 0
      },
      'piip': {
        ramps: {
          "in": 0.8,
          out: 1
        },
        osc1Type: 3,
        osc2Type: 2,
        mod: 5
      },
      'bumm': {
        ramps: {
          "in": 0.1,
          out: 0.1
        },
        osc1Type: 0,
        osc2Type: 0,
        mod: 0
      }
    };

    AudioBoss.prototype.currentInstrument = 'brom';

    AudioBoss.prototype.initialize = function() {
      this.context = new webkitAudioContext();
      this.initOutput();
      this.initInput();
      this.initGenerators();
      this.initEffects();
      this.initExtendedScale('aMinor');
      this.initEvents();
      this.setInstrument('brom');
      return this.initListener();
    };

    AudioBoss.prototype.initOutput = function() {
      this.outGainNode = this.context.createGainNode();
      this.outGainNode.gain.value = 0.7;
      return this.outGainNode.connect(this.context.destination);
    };

    AudioBoss.prototype.initInput = function() {
      this.sourcePanner = this.context.createPanner();
      this.sourcePanner.setPosition(0.7, 0, 0);
      this.sourcePanner.connect(this.outGainNode);
      this.sourceGainNode = this.context.createGainNode();
      this.sourceGainNode.gain.value = 0.5;
      return this.sourceGainNode.connect(this.sourcePanner);
    };

    AudioBoss.prototype.initGenerators = function() {
      this.oscPanner = this.context.createPanner();
      this.oscPanner.setPosition(-0.7, 0, 0);
      this.oscGain = this.context.createGainNode();
      this.oscGain.gain.value = 0;
      this.oscGain.connect(this.oscPanner);
      this.oscPanner.connect(this.outGainNode);
      this.osc1 = this.context.createOscillator();
      this.osc1.type = 0;
      this.osc1.connect(this.oscGain);
      this.osc1.noteOn(0);
      this.osc2 = this.context.createOscillator();
      this.osc2.type = 2;
      this.osc2.connect(this.oscGain);
      this.osc2.noteOn(0);
      this.oscOsc = this.context.createOscillator();
      this.oscOsc.type = 0;
      this.oscOsc.frequency.value = 0.25;
      this.oscOsc.noteOn(0);
      this.oscOscGain = this.context.createGainNode();
      this.oscOscGain.gain.value = 0.5;
      this.oscOsc.connect(this.oscOscGain);
      return this.oscOscGain.connect(this.osc1.frequency);
    };

    AudioBoss.prototype.initListener = function() {
      var _this = this;
      this.peer = new Peer({
        key: 'sbi86lbw0g1d1jor'
      });
      this.conn = this.peer.connect('kekeke');
      this.js = this.context.createScriptProcessor(256, 1, 1);
      this.js.onaudioprocess = function(e) {
        var msg;
        cl('onaudioprocess');
        msg = e.inputBuffer.getChannelData(0).buffer;
        return _this.conn.send(msg);
      };
      return this.js.connect(this.outGainNode);
    };

    AudioBoss.prototype.initEvents = function() {
      var _this = this;
      $(window).on('audio_gen_note_on', function(e, data) {
        var freq;
        freq = _this.floatToFreq(data['x']);
        _this.setOscFrequencies(freq);
        return _this.ramp(0.5 - data['y'] / 2, 'in');
      });
      $(window).on('audio_gen_note_off', function(e) {
        return _this.ramp(0, 'out');
      });
      $(window).on('octave', function(e, data) {
        return _this.initExtendedScale('aMinor', data['octave']);
      });
      $(window).on('instrument', function(e, data) {
        return _this.setInstrument(data['instrument']);
      });
      return $(window).on('audio_mod', function(e, data) {
        return _this.setEffect(data['mod_type'], data['x'], data['y']);
      });
    };

    AudioBoss.prototype.ramp = function(value, type) {
      var now;
      now = this.context.currentTime;
      this.oscGain.gain.cancelScheduledValues(now);
      this.oscGain.gain.setValueAtTime(this.oscGain.gain.value, now);
      console.log(this.instruments[this.currentInstrument]['ramps'][type]);
      return this.oscGain.gain.linearRampToValueAtTime(value, now + this.instruments[this.currentInstrument]['ramps'][type]);
    };

    AudioBoss.prototype.setOscFrequencies = function(freq) {
      this.osc1.frequency.value = freq;
      return this.osc2.frequency.value = freq;
    };

    AudioBoss.prototype.floatToFreq = function(f) {
      return this.scale[Math.round(f * (this.scale.length - 1))];
    };

    AudioBoss.prototype.initExtendedScale = function(scale, octave) {
      var i, j, l, v, _i, _len, _ref, _results;
      if (octave == null) {
        octave = 3;
      }
      octave = parseInt(octave);
      l = this.rootScales[scale].length;
      _ref = this.rootScales[scale];
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        v = _ref[i];
        _results.push((function() {
          var _j, _results1;
          _results1 = [];
          for (j = _j = 0; _j <= 2; j = ++_j) {
            _results1.push(this.scale[i + (j * l)] = Math.pow(2, ((v + (12 * (j + octave))) - 69) / 12) * 440);
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    AudioBoss.prototype.initEffects = function() {
      var _this = this;
      if (!this.source) {
        return "Oh no!";
      }
      this.tuna = new Tuna(this.context);
      this.effects['overdrive'] = new this.tuna.Overdrive({
        outputGain: 0.3,
        drive: 0.5,
        curveAmount: 0.4,
        algorithmIndex: 2,
        bypass: true
      });
      this.effects['delay'] = new this.tuna.Delay({
        feedback: 0,
        delayTime: 250,
        wetLevel: 1,
        dryLevel: 1,
        bypass: true
      });
      this.effects['chorus'] = new this.tuna.Chorus({
        feedback: 0.5,
        rate: 1.5,
        delay: 0.005,
        bypass: true
      });
      this.effects['tremolo'] = new this.tuna.Tremolo({
        intensity: 0.3,
        rate: 0.1,
        stereoPhase: 0,
        bypass: false
      });
      return _.each(this.effects, function(effect) {
        _this.source.connect(effect.input);
        return effect.connect(_this.sourceGainNode);
      });
    };

    AudioBoss.prototype.silenceEffects = function() {
      var effect, _i, _len, _ref, _results;
      _ref = this.effects;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        effect = _ref[_i];
        _results.push(effect.bypass = true);
      }
      return _results;
    };

    AudioBoss.prototype.setEffect = function(effectName, v1, v2) {
      this.silenceEffects();
      if (effectName === 'overdrive') {
        this.effects[effectName].bypass = false;
        this.effects[effectName].drive = v1;
        this.effects[effectName].curveAmount = v2;
      }
      if (effectName === 'delay') {
        this.effects[effectName].bypass = false;
        this.effects[effectName].feedback = v1;
        this.effects[effectName].delayTime = v2 * 1000;
      }
      if (effectName === 'chorus') {
        this.effects[effectName].bypass = false;
        this.effects[effectName].rate = v1 * 20;
        this.effects[effectName].feedback = Math.min(v2, 0.95);
      }
      if (effectName === 'tremolo') {
        this.effects[effectName].bypass = false;
        this.effects[effectName].rate = v1 * 8;
        return this.effects[effectName].intensity = v2;
      }
    };

    AudioBoss.prototype.setInstrument = function(name) {
      this.currentInstrument = name;
      this.osc1.type = this.instruments[name]['osc1Type'];
      this.osc2.type = this.instruments[name]['osc2Type'];
      return this.oscOscGain.gain.value = this.instruments[name]['mod'];
    };

    return AudioBoss;

  })();

  window.AudioBoss = new AudioBoss();

}).call(this);
